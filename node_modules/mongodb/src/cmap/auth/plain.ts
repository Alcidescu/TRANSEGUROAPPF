import { Binary } from '../../bson';
import { MongoMissingCredentialsError } from '../../error';
<<<<<<< HEAD
import { ns } from '../../utils';
import { type AuthContext, AuthProvider } from './auth_provider';

export class Plain extends AuthProvider {
  override async auth(authContext: AuthContext): Promise<void> {
    const { connection, credentials } = authContext;
    if (!credentials) {
      throw new MongoMissingCredentialsError('AuthContext must provide credentials.');
    }

    const { username, password } = credentials;
=======
import { Callback, ns } from '../../utils';
import { AuthContext, AuthProvider } from './auth_provider';

export class Plain extends AuthProvider {
  override auth(authContext: AuthContext, callback: Callback): void {
    const { connection, credentials } = authContext;
    if (!credentials) {
      return callback(new MongoMissingCredentialsError('AuthContext must provide credentials.'));
    }
    const username = credentials.username;
    const password = credentials.password;
>>>>>>> 36e6c1d122dc190a65359e5ccef36f21fa6dd909

    const payload = new Binary(Buffer.from(`\x00${username}\x00${password}`));
    const command = {
      saslStart: 1,
      mechanism: 'PLAIN',
      payload: payload,
      autoAuthorize: 1
    };

<<<<<<< HEAD
    await connection.command(ns('$external.$cmd'), command, undefined);
=======
    connection.command(ns('$external.$cmd'), command, undefined, callback);
>>>>>>> 36e6c1d122dc190a65359e5ccef36f21fa6dd909
  }
}
